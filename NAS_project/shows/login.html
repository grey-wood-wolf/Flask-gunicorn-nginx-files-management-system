<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        body {
            background: url('https://cdn.pixabay.com/photo/2018/08/14/13/23/ocean-3605547_1280.jpg') no-repeat;
            background-size: cover;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 90%;
            max-width: 1200px;
            padding: 20px;
            background-color: #00000060;
            border-radius: 10px;
        }
        .module {
            background-color: #ffffff20;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            overflow: hidden;
        }
        h2 {
            color: #ffffff90;
            margin-top: 0;
        }
        ul {
            list-style-type: none;
            padding: 0;
            text-align: center;
            max-height: 200px;
            overflow-y: auto;
        }
        li {
            display: block;
            margin: 10px 0;
            cursor: pointer;
            color: #fff;
            text-align: center;
        }
        .file-icon {
            width: 30px;
            height: 30px;
            background-color: #fff;
            border-radius: 5px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
        }
        .file-name {
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        form {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ffffff90;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #ffffff20;
            color: #fff;
        }
        select option {
            background-color: #ccc;
            color: #000;
        }
        input[type="file"] {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #ffffff20;
            color: #fff;
        }
        input[type="submit"] {
            background-image: linear-gradient(to right, #30cfd0, #330867);
            color: #fff;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        progress {
            /* é‡ç½®é»˜è®¤å¤–è§‚ */
            -webkit-appearance: none;
            appearance: none;
            display: none;
            margin-top: 10px;
            width: 100%;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;

            /* è®¾ç½®è¿›åº¦æ¡çš„èƒŒæ™¯é¢œè‰² */
            background-color: #9b9b9b;
        }

        /* Webkit æµè§ˆå™¨æ ·å¼ */
        progress::-webkit-progress-bar {
            background-color: #9b9b9b; /* è¿›åº¦æ¡èƒŒæ™¯è‰² */
        }

        progress::-webkit-progress-value {
            background-color: #2599c6; /* è¿›åº¦æ¡å¡«å……è‰² */
        }

        /* Firefox æµè§ˆå™¨æ ·å¼ */
        progress::-moz-progress-bar {
            background-color: #2599c6; /* è¿›åº¦æ¡å¡«å……è‰² */
        }

        /* IE11 and Edge æµè§ˆå™¨æ ·å¼ */
        progress {
            background-color: #9b9b9b; /* IE11/Edge è¿›åº¦æ¡èƒŒæ™¯è‰² */
        }

        progress::-ms-fill {
            background-color: #2599c6; /* IE11/Edge è¿›åº¦æ¡å¡«å……è‰² */
            border: none; /* ç§»é™¤è¾¹æ¡† */
        }
        .status {
            margin-top: 10px;
            font-weight: bold;
        }
        .success {
            color: #79cbfd;
        }
        .error {
            color: #fa8b8b;
        }
        .working {
            color: #cacaca;
        }
        
        @media screen and (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            ul {
                max-height: 150px;
            }
            .file-name {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="module">
            <h2>Storeæ–‡ä»¶å¤¹å†…å®¹</h2>
            <ul id="file-list">
                {% for item in store_contents %}
                    <li>
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-name" title="{{ item }}">{{ item[:30] }}...</div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="module">
            <h2>åˆ é™¤æ–‡ä»¶</h2>
            <form action="{{ url_for('delfile') }}" method="post">
                <select id="filename" name="filename">
                    {% for item in store_contents %}
                        <option value="{{ item }}">{{ item }}</option>
                    {% endfor %}
                </select>
                <input type="submit" value="åˆ é™¤">
            </form>
            <div class="status">
                {% if del_status == 'success' %}
                    <span class="success">æ–‡ä»¶åˆ é™¤æˆåŠŸ</span>
                {% elif del_status == 'error' %}
                    <span class="error">æ–‡ä»¶åˆ é™¤å¤±è´¥</span>
                {% endif %}
            </div>
        </div>
        <div class="module">
            <h2>ä¸Šä¼ æ–‡ä»¶</h2>
            <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
                <input type="file" name="file">
                <input type="submit" value="ä¸Šä¼ ">
            </form>
            <div class="status">
                {% if upload_status == 'success' %}
                    <span class="success">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</span>
                {% elif upload_status == 'error' %}
                    <span class="error">æ–‡ä»¶ä¸Šä¼ å¤±è´¥</span>
                {% endif %}
            </div>
        </div>
        <div class="module">
            <h2>ä¸‹è½½æ–‡ä»¶</h2>
            <form action="{{ url_for('download') }}" method="post">
                <select id="downloadFile" name="filename">
                    {% for item in store_contents %}
                        <option value="{{ item }}">{{ item }}</option>
                    {% endfor %}
                </select>
                <input type="submit" value="ä¸‹è½½" id="download">
            </form>
            <div class="status">
                {% if download_status == 'success' %}
                    <span class="success">æ–‡ä»¶åˆ é™¤æˆåŠŸ</span>
                {% elif download_status == 'error' %}
                    <span class="error">æ–‡ä»¶åˆ é™¤å¤±è´¥</span>
                {% endif %}
            </div>
        </div>
        <div class="module">
            <h2>Socketä¸Šä¼ æ–‡ä»¶</h2>
            <input type="file" id="fileInput">
            <input type="submit" id="socketuploadSubmit" value="ä¸Šä¼ ">
            <progress id="SocketuploadProgress" value="10" max="100"></progress>
            <div class="status">
                <span class="working" id="up_resttime"></span>
                {% if socketupload_status == 'success' %}
                    <span class="success">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</span>
                {% elif socketupload_status == 'error' %}
                    <span class="error">æ–‡ä»¶ä¸Šä¼ å¤±è´¥</span>
                {% endif %}
            </div>
            <script>
                document.getElementById('socketuploadSubmit').addEventListener('click', function(event) {
                    event.preventDefault();
                    const socket = io.connect(`http://${window.location.host}`); // ç¡®ä¿åœ°å€å’Œç«¯å£ä¸æœåŠ¡å™¨åŒ¹é…
                    
                    const resttime= document.getElementById('up_resttime')
                    const progress = document.getElementById('SocketuploadProgress');
                    const fileInput = document.getElementById('fileInput');
                    const file = fileInput.files[0];
                    const CHUNK_SIZE = 512 * 1024;
                    const id = Date.now();
                    let start_time = Date.now();
                    let rest_time = 0;
                    let offset = 0;
                    let last_Bytes = 0;

                    const readSlice = o => {
                        offset = o;
                        const reader = new FileReader();

                        reader.onload = e => {
                            socket.emit('file_upload', {
                                filename: file.name,
                                size: file.size,
                                data: e.target.result,
                                file_id: id
                            });

                            last_Bytes = e.target.result.byteLength;
                        };
                        

                        // æ³¨æ„è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨oä½œä¸ºsliceçš„å¼€å§‹ä½ç½®
                        const slice = file.slice(o, o + CHUNK_SIZE);
                        reader.readAsArrayBuffer(slice);
                    };

                    if (file) {
                        start_time = Date.now();
                        progress.style.display = 'block'; 
                        progress.value = 0;
                        resttime.textContent = `æ–‡ä»¶åœ¨ä¸Šä¼ ï¼Œå‰©ä½™ s`; 
                        readSlice(offset);
                    } else {
                        alert('æœªé€‰æ‹©æ–‡ä»¶ï¼');
                    }

                    socket.on('send_again', function(data) {
                        progress.value = (offset + last_Bytes) / file.size * 100;
                        rest_time = (Date.now() - start_time) * (file.size - offset - last_Bytes) / (offset + last_Bytes);
                        resttime.textContent = `æ–‡ä»¶åœ¨ä¸Šä¼ ï¼Œå‰©ä½™${(rest_time / 1000).toFixed(2)}s`;
                        if (offset + last_Bytes < file.size) {
                            readSlice(offset + CHUNK_SIZE);
                        }
                    });

                    socket.on('socketupload', function(data) {
                        // å‡è®¾ data.params æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«äº†æ‚¨æƒ³è¦å‘é€çš„å‚æ•°
                        var params = new URLSearchParams({status: data.status}).toString();

                        // æ„å»ºå®Œæ•´çš„URLï¼ŒåŒ…å«æŸ¥è¯¢å‚æ•°
                        var urlWithParams = data.url + '?' + params;

                        socket.disconnect();

                        // é‡å®šå‘åˆ°æ–°çš„URL
                        window.location = urlWithParams;
                    });
                });
            </script>
        </div>
        <div class="module">
            <h2>Socketä¸‹è½½æ–‡ä»¶</h2>
            <select id="SocketdownloadFile" name="filename">
                {% for item in store_contents %}
                    <option value="{{ item }}">{{ item }}</option>
                {% endfor %}
            </select>
            <input type="submit" id="socketdownloadSubmit" value="ä¸‹è½½">
            <progress id="SocketdownloadProgress" value="10" max="100"></progress>
            <div class="status">
                <span class="working" id="down_resttime"></span>
                {% if socketdownload_status == 'success' %}
                    <span class="success">æ–‡ä»¶ä¸‹è½½æˆåŠŸ</span>
                {% elif socketdownload_status == 'error' %}
                    <span class="error">æ–‡ä»¶ä¸‹è½½å¤±è´¥</span>
                {% endif %}
            </div>
            <script>
                document.getElementById('socketdownloadSubmit').addEventListener('click', function(event) {
                    event.preventDefault();
                    const resttime= document.getElementById('down_resttime')
                    const progress = document.getElementById('SocketdownloadProgress');
                    const socket = io.connect(`http://${window.location.host}`); // ç¡®ä¿åœ°å€å’Œç«¯å£ä¸æœåŠ¡å™¨åŒ¹é…
                    const filename = document.getElementById('SocketdownloadFile').value;
                    let start_time = Date.now();
                    let filedata = [];
                    //æ£€æŸ¥filenameæ˜¯å¦ä¸ºç©º
                    if (filename){
                        start_time = Date.now();
                        progress.style.display = 'block';
                        progress.value = 0;
                        resttime.textContent = `æ–‡ä»¶åœ¨ä¸‹è½½ï¼Œå‰©ä½™ s`;
                        socket.emit('file_download', {filename: filename});
                    }else{
                        alert('æœªé€‰æ‹©æ–‡ä»¶ï¼');
                    }

                    socket.on('receive', function(data) {
                        filedata.push(data.data);
                        if (data.all_read) {
                            const blob = new Blob(filedata, { type: 'application/octet-stream' });
                            const downloadLink = document.createElement('a');
                            downloadLink.href = window.URL.createObjectURL(blob);
                            downloadLink.download = filename;
                            downloadLink.style.display = 'none';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                            filedata = []; // é‡ç½®æ•°æ®æ•°ç»„


                            var params = new URLSearchParams({status: 'success'}).toString();
                            var urlWithParams = data.url + '?' + params;
                            socket.disconnect();
                            window.location = urlWithParams;
                        }else{
                            progress.value = data.readsize / data.filesize * 100;
                            rest_time = (Date.now() - start_time) * (data.filesize - data.readsize) / data.readsize;
                            resttime.textContent = `æ–‡ä»¶åœ¨ä¸‹è½½ï¼Œå‰©ä½™${(rest_time / 1000).toFixed(2)}s`;
                            socket.emit('file_download', {filename: filename});
                        }
                    });

                });

            </script>
        </div>
        <div class="module">
            <h2>webç»ˆç«¯</h2>
            <form onsubmit="return openWebTerminal();">
                <input type="submit" value="è¿æ¥webterminal">
            </form>

            <script>
                function openWebTerminal() {
                    window.open('/webterminal', '_blank');
                    return false; // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸º
                }
            </script>
        </div>

    </div>
</body>
</html>